<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>KaTeX Test</title>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="js/katex/katex.min.css">

    <!-- KaTeX JavaScript -->
    <script src="js/katex/katex.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .option { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>KaTeX Test Page</h1>

    <div class="test-section">
        <h2>Static Math (should render immediately)</h2>
        <p>Inline math: <span id="static-inline">$x^2 + 2x + 1$</span></p>
        <p>Display math: <span id="static-display">$$\int_0^3 2x \, dx = x^2\Big|_0^3 = 9$$</span></p>
    </div>

    <div class="test-section">
        <h2>Dynamic Math Options (like in exam)</h2>
        <div id="dynamic-options"></div>
        <button onclick="renderDynamicOptions()">Render Options</button>
    </div>

    <div class="test-section">
        <h2>Question Text</h2>
        <div id="question-text"></div>
        <button onclick="renderQuestion()">Render Question</button>
    </div>

    <script>
        // KaTeX rendering function (same as in main app)
        window.renderMathInElement = function(element) {
            if (!element) return Promise.resolve();

            try {
                console.log('Rendering math in element:', element);

                // Find all text nodes and render LaTeX
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );

                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    if (node.textContent.includes('$')) {
                        textNodes.push(node);
                    }
                }

                console.log('Found', textNodes.length, 'text nodes with math');

                textNodes.forEach(textNode => {
                    const parent = textNode.parentNode;
                    const text = textNode.textContent;
                    console.log('Processing text:', text);

                    // Replace inline math $...$ and display math $$...$$
                    let html = text
                        .replace(/\$\$([^$]+)\$\$/g, (match, tex) => {
                            try {
                                return katex.renderToString(tex, { displayMode: true });
                            } catch (e) {
                                console.error('KaTeX display math error:', e, 'for:', tex);
                                return match;
                            }
                        })
                        .replace(/\$([^$]+)\$/g, (match, tex) => {
                            try {
                                return katex.renderToString(tex, { displayMode: false });
                            } catch (e) {
                                console.error('KaTeX inline math error:', e, 'for:', tex);
                                return match;
                            }
                        });

                    if (html !== text) {
                        console.log('Replacing text with rendered math');
                        const span = document.createElement('span');
                        span.innerHTML = html;
                        parent.replaceChild(span, textNode);
                    }
                });

                console.log('KaTeX rendering complete for element');
                return Promise.resolve();
            } catch (error) {
                console.error('KaTeX rendering error:', error);
                return Promise.resolve();
            }
        };

        function renderDynamicOptions() {
            const container = document.getElementById('dynamic-options');
            container.innerHTML = `
                <div class="option">
                    <label>
                        <input type="radio" name="test" value="0">
                        <span class="option-text">$x$</span>
                    </label>
                </div>
                <div class="option">
                    <label>
                        <input type="radio" name="test" value="1">
                        <span class="option-text">$2x$</span>
                    </label>
                </div>
                <div class="option">
                    <label>
                        <input type="radio" name="test" value="2">
                        <span class="option-text">$x^2$</span>
                    </label>
                </div>
                <div class="option">
                    <label>
                        <input type="radio" name="test" value="3">
                        <span class="option-text">$2$</span>
                    </label>
                </div>
            `;

            setTimeout(() => {
                window.renderMathInElement(container);
            }, 10);
        }

        function renderQuestion() {
            const container = document.getElementById('question-text');
            container.innerHTML = '<h4>The derivative of $x^2$ with respect to $x$ is:</h4>';

            setTimeout(() => {
                window.renderMathInElement(container);
            }, 10);
        }

        // Render static math on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, rendering static math...');
            window.renderMathInElement(document.getElementById('static-inline'));
            window.renderMathInElement(document.getElementById('static-display'));
        });
    </script>
</body>
</html>
