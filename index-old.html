<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Offline Examination System | Ramakrishna Mission</title>
    <meta name="viewport" content="width=device-width, initial-sc        });
    <meta name="description" content="Offline Examination System for Ramakrishna Mission Home of Service">
    <link rel="shortcut icon" href="images/favicon.svg" type="image/svg+xml" />

    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <link href="css/enhanced-style.css" rel="stylesheet" type="text/css">
    <link href="css/exam-interface.css" rel="stylesheet" type="text/css">

    <!-- Inline CSS for Icons - No External Requests -->
    <style>
        /* FontAwesome Icon Base Styles */
        .fas, .far, .fab, .fa {
            display: inline-block;
            font-style: normal;
            font-variant: normal;
            text-rendering: auto;
            line-height: 1;
            margin-right: 5px;
        }
        
        /* Icon replacements using Unicode characters */
        .fa-info-circle::before { content: "‚Ñπ"; }
        .fa-exclamation-triangle::before { content: "‚ö†"; }
        .fa-clock::before { content: "üïê"; }
        .fa-mouse-pointer::before { content: "üëÜ"; }
        .fa-check-circle::before { content: "‚úì"; }
        .fa-graduation-cap::before { content: "üéì"; }
        .fa-school::before { content: "üè´"; }
        .fa-book::before { content: "üìö"; }
        .fa-list::before { content: "üìã"; }
        .fa-file-alt::before { content: "üìÑ"; }
        .fa-play::before { content: "‚ñ∂"; }
        .fa-copyright::before { content: "¬©"; }
        
        /* Color classes for icons */
        .text-warning { color: #ffc107 !important; }
        .text-info { color: #17a2b8 !important; }
        .text-success { color: #28a745 !important; }
        .text-primary { color: #007bff !important; }

        /* Loading spinner styles */
        .loading-spinner {
            display: none; /* Hidden since we don't need loading for embedded data */
        }

        /* Error message styles */
        .error-message {
            display: none; /* Hidden since no network errors possible */
        }
    </style>

    <!-- Offline Exam System - No CORS Issues -->
    <script src="js/embedded-exam-data.js" type="text/javascript"></script>
    <script src="js/offline-exam-system.js" type="text/javascript"></script>
</head>

<body>
    <!-- Logo Section -->
    <div class="logo-container">
        <img src="images/label.png" class="img-fluid" alt="Ramakrishna Mission Logo">
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-11 col-md-12">
                <div class="main-container">
                    <div class="workblock">
                        <div class="row">
                            <!-- Instructions Section -->
                            <div class="col-lg-7 col-md-12 instructions-section borderright">
                                <h1><i class="fas fa-info-circle"></i> Examination Instructions</h1>
                                <h3>[Read all instructions carefully before proceeding]</h3>
                                <div class="redunderline"></div>

                                <div class="instruction-list">
                                    <div class="instruction-item">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        <strong>Do not refresh</strong> the page during the exam
                                    </div>
                                    <div class="instruction-item">
                                        <i class="fas fa-clock text-info"></i>
                                        Try to <strong>finish the exam within time</strong>
                                    </div>
                                    <div class="instruction-item">
                                        <i class="fas fa-calculator text-success"></i>
                                        <strong>Automatic evaluation</strong> will start at the end of stipulated time or submission
                                    </div>
                                    <div class="instruction-item">
                                        <i class="fas fa-database text-secondary"></i>
                                        This system works <strong>offline</strong> after initial data loading
                                    </div>
                                </div>


                            </div>

                            <!-- Exam Selection Section -->
                            <div class="col-lg-5 col-md-12 exam-form-section">
                                <h1><i class="fas fa-graduation-cap"></i> Choose Exam</h1>

                                <form method="post" name="examForm" action="examboard.php" onSubmit="return validateForm();">
                                    <!-- Class Selection -->
                                    <div class="form-group">
                                        <label for="cclass"><i class="fas fa-school"></i> Select Class</label>
                                        <select class="form-control" name="cclass" id="cclass" onChange="getSubject(this.value);" required>
                                            <option value="">Choose Class...</option>
                                        </select>
                                        <div class="loading-spinner" id="classLoading">
                                            <div class="spinner"></div>
                                        </div>
                                        <div class="error-message" id="classError"></div>
                                    </div>

                                    <!-- Subject Selection -->
                                    <div class="form-group">
                                        <label for="csubject"><i class="fas fa-book"></i> Select Subject</label>
                                        <div id="subjectValue">
                                            <select class="form-control" name="csubject" id="csubject" onChange="getTopic(this.value, document.getElementById('cclass').value);" required>
                                                <option value="">First select a class</option>
                                            </select>
                                        </div>
                                        <div class="loading-spinner" id="subjectLoading">
                                            <div class="spinner"></div>
                                        </div>
                                        <div class="error-message" id="subjectError"></div>
                                    </div>

                                    <!-- Topic Selection -->
                                    <div class="form-group">
                                        <label for="ctopic"><i class="fas fa-list"></i> Select Topic</label>
                                        <div id="topicValue">
                                            <select class="form-control" name="ctopic" id="ctopic" onChange="getPaper(this.value, document.getElementById('csubject').value, document.getElementById('cclass').value);" required>
                                                <option value="">First select a subject</option>
                                            </select>
                                        </div>
                                        <div class="loading-spinner" id="topicLoading">
                                            <div class="spinner"></div>
                                        </div>
                                        <div class="error-message" id="topicError"></div>
                                    </div>

                                    <!-- Paper Selection -->
                                    <div class="form-group">
                                        <label for="cpaper"><i class="fas fa-file-alt"></i> Select Paper</label>
                                        <div id="paperValue">
                                            <select class="form-control" name="cpaper" id="cpaper" required>
                                                <option value="">First select a topic</option>
                                            </select>
                                        </div>
                                        <div class="loading-spinner" id="paperLoading">
                                            <div class="spinner"></div>
                                        </div>
                                        <div class="error-message" id="paperError"></div>
                                    </div>

                                    <!-- Submit Button -->
                                    <div class="text-center">
                                                                <button type="button" id="startExamBtn" class="btn btn-primary btn-lg">Start Exam</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Interface Container (Hidden by default) -->
    <div id="examContainer" class="exam-container" style="display: none;">
        <!-- This will be populated by the exam interface -->
    </div>

    <!-- Footer -->
    <div class="homecopyright">
        <i class="fas fa-copyright"></i> 2025 Ramakrishna Mission Home of Service, Luxa, Varanasi, Uttar Pradesh | All Rights Reserved
        <br>
        <small>Offline Examination System v2.0</small>
    </div>

    <!-- Offline Exam System Initialization -->
    <script type="text/javascript">
        // Initialize the offline exam system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Starting Offline Exam System...');
            console.log('üìö Loaded exam data with', window.examData.structure.classes.length, 'classes');
            
            // Initialize the system
            window.offlineExamSystem.init();
            
            console.log('‚úÖ Offline Exam System ready - No network requests needed!');
        });

        /**
         * Initialize the offline examination system
         */
        async function initializeSystem() {
            try {


                // Wait a moment for all script files to load
                await new Promise(resolve => setTimeout(resolve, 100));

                // Check if JSON-based data loader is available
                if (typeof window.examDataLoader === 'undefined') {
                    throw new Error('Exam data loader not available');
                }

                // Initialize the JSON-based exam system
                await window.examDataLoader.initializeExamSystem();

                // Check if system is ready
                const stats = window.examDataLoader.getSystemStats();
                if (stats.totalClasses === 0) {
                    throw new Error('No exam data available');
                }

                systemReady = true;

                console.log('‚úÖ JSON-based exam system initialized successfully');
                console.log('üìä System Stats:', stats);

            } catch (error) {
                console.error('System initialization failed:', error);

                systemReady = false;
            }
        }

        /**
         * Update system status indicator
         */


        /**
         * Load classes data and populate dropdown
         */
        async function loadClasses() {
            try {
                showLoading('class');

                // Ensure the exam system is initialized
                if (!window.examDataLoader) {
                    throw new Error('Exam data loader not available');
                }

                // If structure is not loaded yet, initialize it
                if (!window.examDataLoader.examStructure) {
                    console.log('üìã Exam structure not loaded yet, initializing...');
                    await window.examDataLoader.initializeExamSystem();
                }

                // Get classes from JSON-based system

                if (!window.examDataLoader.examStructure) {
                    throw new Error('Exam structure not loaded');
                }

                const classes = window.examDataLoader.examStructure.classes;
                loadedData.classes = classes;

                const classSelect = document.getElementById('cclass');

                // Clear existing options
                classSelect.innerHTML = '<option value="">Choose Class...</option>';

                classes.forEach((cls, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = cls.name;
                    classSelect.appendChild(option);
                });

                hideLoading('class');
                markFieldAsSuccess('cclass');

            } catch (error) {
                console.error('Error loading classes:', error);
                hideLoading('class');
                showError('class', 'Failed to load classes data');
            }
        }

        /**
         * Load subjects for selected class
         */
        async function getSubject(classIndex) {
            if (classIndex === '') {
                resetSubjects();
                return;
            }

            try {
                showLoading('subject');

                // Store selected class index
                loadedData.selectedClassIndex = parseInt(classIndex);

                // Get subjects from JSON-based system
                const classObj = window.examDataLoader.examStructure.classes[classIndex];
                if (!classObj) {
                    throw new Error('Class not found');
                }
                const subjects = classObj.subjects;
                loadedData.subjects[classIndex] = subjects;

                const subjectSelect = document.getElementById('csubject');
                subjectSelect.innerHTML = '<option value="">Choose Subject...</option>';

                subjects.forEach((subject, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });

                // Ensure the onChange attribute is set
                subjectSelect.setAttribute('onChange', `getTopic(this.value, ${classIndex});`);

                hideLoading('subject');
                markFieldAsSuccess('csubject');

                // Reset dependent dropdowns
                resetTopics();
                resetPapers();

            } catch (error) {
                console.error('Error loading subjects:', error);
                hideLoading('subject');
                showError('subject', 'Failed to load subjects data');
            }
        }

        /**
         * Load topics for selected subject
         */
        async function getTopic(subjectIndex, classIndex) {
            if (subjectIndex === '') {
                resetTopics();
                return;
            }

            try {
                showLoading('topic');

                // Store selected subject index
                loadedData.selectedSubjectIndex = parseInt(subjectIndex);

                // Get topics from JSON-based system
                const classObj = window.examDataLoader.examStructure.classes[classIndex];
                const subjectObj = classObj?.subjects[subjectIndex];
                if (!subjectObj) {
                    throw new Error('Subject not found');
                }
                const topics = subjectObj.topics;
                loadedData.topics[subjectIndex] = topics;

                const topicSelect = document.getElementById('ctopic');
                topicSelect.innerHTML = '<option value="">Choose Topic...</option>';

                topics.forEach((topic, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = topic.name;
                    topicSelect.appendChild(option);
                });

                // Ensure the onChange attribute is set
                topicSelect.setAttribute('onChange', `getPaper(this.value, ${subjectIndex}, ${classIndex});`);

                hideLoading('topic');
                markFieldAsSuccess('ctopic');

                // Reset dependent dropdown
                resetPapers();

            } catch (error) {
                console.error('Error loading topics:', error);
                hideLoading('topic');
                showError('topic', 'Failed to load topics data');
            }
        }

        /**
         * Load papers for selected topic
         */
        async function getPaper(topicIndex, subjectIndex, classIndex) {
            if (topicIndex === '') {
                resetPapers();
                return;
            }

            try {
                showLoading('paper');

                // Store selected topic index
                loadedData.selectedTopicIndex = parseInt(topicIndex);

                // Get papers from JSON-based system
                const classObj = window.examDataLoader.examStructure.classes[classIndex];
                const subjectObj = classObj?.subjects[subjectIndex];
                const topicObj = subjectObj?.topics[topicIndex];
                if (!topicObj) {
                    throw new Error('Topic not found');
                }
                const papers = topicObj.papers;
                loadedData.papers[topicIndex] = papers;

                const paperSelect = document.getElementById('cpaper');
                paperSelect.innerHTML = '<option value="">Choose Paper...</option>';

                papers.forEach((paper, paperIndex) => {
                    const duration = paper.duration ? ` (${paper.duration} min, ${paper.questions} questions)` : '';
                    const option = document.createElement('option');
                    option.value = paperIndex;
                    option.textContent = paper.name + duration;
                    paperSelect.appendChild(option);
                });

                hideLoading('paper');
                markFieldAsSuccess('cpaper');

            } catch (error) {
                console.error('Error loading papers:', error);
                hideLoading('paper');
                showError('paper', 'Failed to load papers data');
            }
        }

        /**
         * Form validation
         */
        function validateForm() {
            const form = document.forms["examForm"];
            const fields = [
                { name: 'cclass', label: 'Class' },
                { name: 'csubject', label: 'Subject' },
                { name: 'ctopic', label: 'Topic' },
                { name: 'cpaper', label: 'Paper' }
            ];

            for (let field of fields) {
                const value = form[field.name].value;
                if (!value || value === "" || value === field.label) {
                    showAlert(`${field.label} must be selected`, 'error');
                    markFieldAsError(field.name);
                    return false;
                }
            }

            showAlert('Proceeding to examination...', 'success');
            return true;
        }

        // Utility functions
        function showLoading(type) {
            const element = document.getElementById(`${type}Loading`);
            if (element) element.style.display = 'block';
        }

        function hideLoading(type) {
            const element = document.getElementById(`${type}Loading`);
            if (element) element.style.display = 'none';
        }

        function showError(type, message) {
            const errorElement = document.getElementById(`${type}Error`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => errorElement.style.display = 'none', 5000);
            }
        }

        function markFieldAsSuccess(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.remove('error');
                field.classList.add('success');
            }
        }

        function markFieldAsError(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.remove('success');
                field.classList.add('error');
            }
        }

        function resetSubjects() {
            const subjectSelect = document.getElementById('csubject');
            if (subjectSelect) {
                subjectSelect.innerHTML = '<option value="">First select a class</option>';
                subjectSelect.removeAttribute('onChange');
            }
            resetTopics();
            resetPapers();
        }

        function resetTopics() {
            const topicSelect = document.getElementById('ctopic');
            if (topicSelect) {
                topicSelect.innerHTML = '<option value="">First select a subject</option>';
                topicSelect.removeAttribute('onChange');
            }
            resetPapers();
        }

        function resetPapers() {
            const paperSelect = document.getElementById('cpaper');
            if (paperSelect) {
                paperSelect.innerHTML = '<option value="">First select a topic</option>';
            }
        }

        function showAlert(message, type) {
            const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
            const icon = type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                <i class="${icon}"></i> ${message}
                <button type="button" class="btn-close" aria-label="Close"></button>
            `;

            // Add click handler for close button
            const closeBtn = alertDiv.querySelector('.btn-close');
            closeBtn.addEventListener('click', function() {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            });

            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Add new alert at the top of the form
            const formTitle = document.querySelector('.exam-form-section h1');
            if (formTitle) {
                formTitle.insertAdjacentElement('afterend', alertDiv);
            }

            // Auto-dismiss after 3 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.style.opacity = '0';
                        setTimeout(() => alertDiv.remove(), 300);
                    }
                }, 3000);
            }
        }

        // Backward compatibility functions (these maintain the original function names)
        window.getSubject = getSubject;
        window.getTopic = getTopic;
        window.getPaper = getPaper;
        window.validateForm = validateForm;

        // Function to bind event listeners (reusable after content restoration)
        function bindEventListeners() {
            // Start Exam Button Click Event
            const startExamBtn = document.getElementById('startExamBtn');
            if (startExamBtn) {
                // Remove any existing listeners to avoid duplicates
                startExamBtn.replaceWith(startExamBtn.cloneNode(true));
                document.getElementById('startExamBtn').addEventListener('click', function() {
                    const selectedClass = document.getElementById('cclass').value;
                    const selectedSubject = document.getElementById('csubject').value;
                    const selectedTopic = document.getElementById('ctopic').value;
                    const selectedPaper = document.getElementById('cpaper').value;

                    if (!selectedClass || !selectedSubject || !selectedTopic || !selectedPaper) {
                        alert('Please select all fields before starting the exam.');
                        return;
                    }

                    // Start the exam using the exam interface
                    if (window.examInterface) {
                        window.examInterface.startExam(selectedClass, selectedSubject, selectedTopic, selectedPaper);
                    } else {
                        alert('Exam interface not loaded. Please refresh the page.');
                    }
                });
                console.log('üîó Re-bound start exam button event listener');
            }
        }

        // Bind event listeners initially
        bindEventListeners();

        // Make the function globally available for restoration
        window.bindEventListeners = bindEventListeners;



        // Initialize JSON-based exam system
        document.addEventListener('DOMContentLoaded', function() {
            // Store original body content for offline navigation
            if (window.examInterface && !window.examInterface.originalBodyContent) {
                // Convert images to data URLs to avoid network requests on restore
                const images = document.querySelectorAll('img');
                const imageConversionPromises = Array.from(images).map(img => {
                    return new Promise((resolve) => {
                        if (img.complete) {
                            convertImageToDataURL(img).then(resolve);
                        } else {
                            img.onload = () => convertImageToDataURL(img).then(resolve);
                            img.onerror = resolve; // Continue even if image fails
                        }
                    });
                });

                // Store content after images are converted to data URLs
                Promise.all(imageConversionPromises).then(() => {
                    setTimeout(() => {
                        window.examInterface.originalBodyContent = document.body.innerHTML;
                        console.log('üìÑ Stored original home page content with embedded images for offline navigation (length:', window.examInterface.originalBodyContent.length, 'chars)');
                    }, 100);
                });

                // Helper function to convert image to data URL
                function convertImageToDataURL(img) {
                    return new Promise((resolve) => {
                        try {
                            // Create a canvas to convert image to data URL
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // Set canvas dimensions to match image
                            canvas.width = img.naturalWidth || img.width;
                            canvas.height = img.naturalHeight || img.height;

                            // Draw image on canvas
                            ctx.drawImage(img, 0, 0);

                            // Convert to data URL and update img src
                            const dataURL = canvas.toDataURL('image/png');
                            const originalSrc = img.src;
                            img.src = dataURL;

                            console.log('üñºÔ∏è Converted image to data URL:', originalSrc, '‚Üí', dataURL.substring(0, 50) + '...');
                            resolve();
                        } catch (error) {
                            console.warn('Could not convert image to data URL:', img.src, error);
                            resolve(); // Continue even if conversion fails
                        }
                    });
                }
            }

            if (window.examDataLoader) {
                console.log('üöÄ Initializing JSON-based exam system...');
                window.examDataLoader.initializeExamSystem().then(() => {
                    console.log('‚úÖ JSON-based exam system ready for offline use');

                    // Log system statistics
                    const stats = window.examDataLoader.getSystemStats();
                    console.log('üìä System Stats:', stats);
                }).catch(error => {
                    console.error('‚ùå Failed to initialize JSON-based exam system:', error);
                    console.warn('Falling back to any available hardcoded data...');
                });
            }
        });
    </script>
</body>
</html>
